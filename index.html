<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hidrantes Maldonado — Retículo + Filtros</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0ea5e9"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: .6rem .8rem; display: grid; gap: .6rem; grid-template-columns: 1fr; align-items: center; box-shadow: 0 1px 6px rgba(0,0,0,.08); position: sticky; top: 0; background: white; z-index: 10000; }
    .row { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    .btn { padding: 1rem 1.1rem; border-radius: 14px; border: 1px solid #e5e7eb; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 1rem; touch-action: manipulation; transform: translateZ(0); transition: transform .06s ease, box-shadow .12s ease; box-shadow: 0 6px 14px rgba(14,165,233,.25); }
    .btn.secondary { background: white; color: #0f172a; }
    .btn:active { transform: scale(.96); }
    .btn.bounce { animation: tap .14s ease; }
    @keyframes tap { 0%{transform:scale(1)} 50%{transform:scale(.95)} 100%{transform:scale(1)} }
    .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border:1px solid #e5e7eb; border-radius:999px; background:white; font-size:.95rem; }
    #map { height: 100%; position: relative; z-index: 0; }
    .reticle {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 24px; height: 24px; border: 2px solid #0ea5e9; border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(14,165,233,.25);
      background: rgba(255,255,255,.6); backdrop-filter: blur(2px);
      z-index: 9000; pointer-events: none;
    }
    .reticle:after {
      content: ""; position:absolute; left:50%; top:50%; width:14px; height:2px; background:#0ea5e9; transform: translate(-50%,-50%);
    }
    .legend { position: absolute; bottom: 12px; left: 12px; background: white; padding: .6rem .7rem; border-radius: .6rem; border: 1px solid #e5e7eb; box-shadow: 0 2px 12px rgba(0,0,0,.08); font-size: .9rem; z-index: 8000; }
    .legend-row { display: grid; grid-template-columns: 22px 1fr; gap: .5rem; align-items: center; margin: .15rem 0; }
    .dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #0f172a10; display: grid; place-items: center; background: white; }
    .mini { width: 12px; height: 12px; border-radius: 50%; display:inline-block; margin-right:.25rem; }
    .toast { position:fixed; top:12px; right:12px; background:rgba(0,0,0,.84); color:white; padding:.6rem .8rem; border-radius:.6rem; font-size:.95rem; z-index: 12000; pointer-events:none; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .filters { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }
    .filters label { display:flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border:1px solid #e5e7eb; border-radius:999px; background:#fff; }
    @media (max-width: 640px) {
      .btn { flex: 1 1 auto; }
      header { padding: .6rem .6rem; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="row">
        <button id="setStartHere" type="button" class="btn">Fijar INICIO aquí</button>
        <button id="setEndHere" type="button" class="btn">Fijar DESTINO aquí</button>
      </div>
      <div class="row">
        <button id="useMyLocationStart" type="button" class="btn secondary">Usar mi ubicación para INICIO</button>
        <button id="useMyLocationEnd" type="button" class="btn secondary">Usar mi ubicación para DESTINO</button>
      </div>
      <div class="row filters">
        <strong>Excluir estados:</strong>
        <label><input type="checkbox" class="stateFilter" value="mal"> Mal</label>
        <label><input type="checkbox" class="stateFilter" value="mantenimiento"> Mantenimiento</label>
        <label><input type="checkbox" class="stateFilter" value="bueno"> Bueno</label>
        <label><input type="checkbox" class="stateFilter" value="excelente"> Excelente</label>
      </div>
      <div class="row">
        <button id="routeBtn" type="button" class="btn">Rutar por hidrante cercano a la ruta</button>
        <button id="clearBtn" type="button" class="btn secondary">Limpiar</button>
        <span class="chip"><span class="mini" style="background:#ef4444"></span> Mal</span>
        <span class="chip"><span class="mini" style="background:#f59e0b"></span> Mantenimiento</span>
        <span class="chip"><span class="mini" style="background:#22c55e"></span> Bueno</span>
        <span class="chip"><span class="mini" style="background:#3b82f6"></span> Excelente</span>
      </div>
    </header>
    <div id="map"></div>
    <div class="reticle" aria-hidden="true"></div>
    <div class="legend">
      <div class="legend-row"><span class="dot" style="border-color:#ef44441a"><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white"/><circle cx="12" cy="12" r="9" fill="none" stroke="#ef4444" stroke-width="2"/></svg></span>Mal</div>
      <div class="legend-row"><span class="dot" style="border-color:#f59e0b1a"><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white"/><circle cx="12" cy="12" r="9" fill="none" stroke="#f59e0b" stroke-width="2"/></svg></span>Mantenimiento</div>
      <div class="legend-row"><span class="dot" style="border-color:#22c55e1a"><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white"/><circle cx="12" cy="12" r="9" fill="none" stroke="#22c55e" stroke-width="2"/></svg></span>Bueno</div>
      <div class="legend-row"><span class="dot" style="border-color:#3b82f61a"><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white"/><circle cx="12" cy="12" r="9" fill="none" stroke="#3b82f6" stroke-width="2"/></svg></span>Excelente</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script>
    const CENTER = [-34.905, -54.948]; // Maldonado
    const map = L.map('map', { tap: true }).setView(CENTER, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const hidrantes = [
      { id: 'H-001', lat: -34.9075, lng: -54.9512, estado: 'excelente' },
      { id: 'H-002', lat: -34.9061, lng: -54.9437, estado: 'bueno' },
      { id: 'H-003', lat: -34.9122, lng: -54.9465, estado: 'mantenimiento' },
      { id: 'H-004', lat: -34.9004, lng: -54.9529, estado: 'mal' },
      { id: 'H-005', lat: -34.8981, lng: -54.9402, estado: 'bueno' },
      { id: 'H-006', lat: -34.9139, lng: -54.9557, estado: 'excelente' },
      { id: 'H-007', lat: -34.9031, lng: -54.9588, estado: 'mantenimiento' },
      { id: 'H-008', lat: -34.8958, lng: -54.9484, estado: 'mal' },
      { id: 'H-009', lat: -34.9022, lng: -54.9451, estado: 'bueno' },
      { id: 'H-010', lat: -34.9098, lng: -54.9493, estado: 'mal' },
      { id: 'H-011', lat: -34.9115, lng: -54.9408, estado: 'excelente' },
      { id: 'H-012', lat: -34.8996, lng: -54.9564, estado: 'mantenimiento' },
      { id: 'H-013', lat: -34.9057, lng: -54.9389, estado: 'bueno' },
      { id: 'H-014', lat: -34.8942, lng: -54.9531, estado: 'mal' },
      { id: 'H-015', lat: -34.8979, lng: -54.9447, estado: 'excelente' },
      { id: 'H-016', lat: -34.9107, lng: -54.9576, estado: 'bueno' },
      { id: 'H-017', lat: -34.9043, lng: -54.9417, estado: 'mantenimiento' },
      { id: 'H-018', lat: -34.8966, lng: -54.9506, estado: 'mal' }
    ];

    const estadoColor = { mal: '#ef4444', mantenimiento: '#f59e0b', bueno: '#22c55e', excelente: '#3b82f6' };

    function hydrantIcon(estado){
      const stroke = estadoColor[estado] || '#3b82f6';
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 36 36'>
          <circle cx='18' cy='18' r='16' fill='white' stroke='${stroke}' stroke-width='3'/>
          <g transform='translate(6,6)' fill='none' stroke='${stroke}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
            <path d='M6 4h12' /><path d='M5 8h14' /><path d='M8 12h8' /><path d='M12 0v2' /><path d='M12 16v2' />
            <rect x='9' y='4' width='6' height='8' rx='1' fill='${stroke}' opacity='0.18' />
            <circle cx='12' cy='8' r='1.8' fill='white'/>
          </g>
        </svg>`);
      return L.divIcon({ className: 'hydrant-icon', html: `<img alt="hidrante ${estado}" src="data:image/svg+xml;utf8,${svg}">`, iconSize: [36,36], iconAnchor:[18,33], popupAnchor:[0,-28] });
    }

    async function obtenerInterseccion(lat, lng){
      try {
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`[out:json][timeout:10];way(around:50,${lat},${lng})[highway][name];out tags center;`)}`;
        const r = await fetch(url); const j = await r.json();
        if (!j.elements || j.elements.length === 0) return null;
        const p = {lat, lng};
        const list = j.elements.filter(e=>e.type==='way' && e.tags && e.tags.name && e.center)
          .map(e=>({name:e.tags.name, center:e.center}))
          .sort((a,b)=>{
            const da = (a.center.lat-p.lat)**2 + (a.center.lon-p.lng)**2;
            const db = (b.center.lat-p.lat)**2 + (b.center.lon-p.lng)**2;
            return da-db;
          });
        if (!list.length) return null;
        const primary = list[0].name;
        let secondary = null;
        for (let i=1;i<list.length;i++){ if (list[i].name !== primary){ secondary = list[i].name; break; } }
        return { primary, secondary };
      } catch(e){ return null; }
    }

    // Render + filters
    let hydrantMarkers = [];
    function excludedStates(){
      const set = new Set();
      document.querySelectorAll('.stateFilter').forEach(cb => { if (cb.checked) set.add(cb.value); });
      return set;
    }
    function renderHydrants() {
      hydrantMarkers.forEach(m => map.removeLayer(m));
      hydrantMarkers = [];
      const ex = excludedStates();
      hidrantes.forEach(h => {
        if (ex.has(h.estado)) return; // excluded
        const marker = L.marker([h.lat, h.lng], { icon: hydrantIcon(h.estado) }).addTo(map);
        marker.on('click', async () => {
          marker.bindPopup(`<strong>${h.id}</strong><br>Estado: ${h.estado}<br><em>Buscando intersección...</em>`).openPopup();
          const inter = await obtenerInterseccion(h.lat, h.lng);
          const interText = inter ? (inter.secondary ? `${inter.primary} y ${inter.secondary}` : `${inter.primary}`) : 'Intersección no disponible';
          marker.setPopupContent(`<strong>${h.id}</strong><br>Estado: ${h.estado}<br>Intersección: ${interText}`);
        });
        marker.h = h;
        hydrantMarkers.push(marker);
      });
    }
    document.querySelectorAll('.stateFilter').forEach(cb => cb.addEventListener('change', renderHydrants));
    renderHydrants();

    // Reticle + start/end
    function mapCenterLatLng(){ const c = map.getCenter(); return {lat: c.lat, lng: c.lng}; }
    let startMarker = null, endMarker = null, routingControl = null;

    function setPoint(which){
      const {lat, lng} = mapCenterLatLng();
      if (which === 'start'){
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Inicio').openPopup();
      } else {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Destino').openPopup();
      }
    }

    function geo(which){
      if (!navigator.geolocation){ toast('Geolocalización no disponible'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat,lng], 15, {animate:true});
        if (which === 'start'){
          if (startMarker) map.removeLayer(startMarker);
          startMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Inicio (GPS)').openPopup();
        } else {
          if (endMarker) map.removeLayer(endMarker);
          endMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Destino (GPS)').openPopup();
        }
      }, _ => toast('No se pudo obtener ubicación'), { enableHighAccuracy:true, timeout:8000, maximumAge:2000 });
    }

    // Distance helpers (planar approximation using scaling by cos(lat))
    function metersPerDegree(lat){ const rad = lat * Math.PI/180; const m = 111320; return { mx: m*Math.cos(rad), my: m }; }
    function pointSegDistMeters(px,py, ax,ay, bx,by){
      const dx = bx-ax, dy = by-ay;
      if (dx===0 && dy===0){ const ddx = px-ax, ddy=py-ay; return Math.hypot(ddx,ddy); }
      const t = Math.max(0, Math.min(1, ((px-ax)*dx + (py-ay)*dy) / (dx*dx+dy*dy)));
      const cx = ax + t*dx, cy = ay + t*dy;
      return Math.hypot(px-cx, py-cy);
    }

    async function fetchBaseRoute(start, end){
      const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
      const r = await fetch(url);
      const j = await r.json();
      if (!j.routes || !j.routes.length) throw new Error('Sin ruta base');
      return j.routes[0].geometry.coordinates.map(([lng,lat])=>({lat,lng}));
    }

    function distanceHydrantToRouteMeters(h, routeCoords){
      if (!routeCoords || routeCoords.length<2) return Infinity;
      const lat0 = routeCoords[0].lat;
      const {mx,my} = metersPerDegree(lat0);
      const hx = h.lng*mx, hy = h.lat*my;
      let best = Infinity;
      for (let i=1;i<routeCoords.length;i++){
        const a = routeCoords[i-1], b = routeCoords[i];
        const ax = a.lng*mx, ay = a.lat*my;
        const bx = b.lng*mx, by = b.lat*my;
        const d = pointSegDistMeters(hx,hy,ax,ay,bx,by);
        if (d<best) best=d;
      }
      return best;
    }

    async function routeViaNearestToRoute(){
      if (!startMarker || !endMarker){ toast('Fijá INICIO y DESTINO'); return; }
      const start = startMarker.getLatLng();
      const end = endMarker.getLatLng();

      // 1) Fetch base route Start->End
      let baseCoords;
      try{
        baseCoords = await fetchBaseRoute(start, end);
      }catch(e){ toast('No se pudo obtener la ruta base'); return; }

      // 2) Among allowed hydrants, pick nearest to that base route
      const ex = excludedStates();
      let best = null, bestD = Infinity;
      hidrantes.forEach(h => {
        if (ex.has(h.estado)) return;
        const d = distanceHydrantToRouteMeters(h, baseCoords);
        if (d < bestD){ best = h; bestD = d; }
      });
      if (!best){ toast('No hay hidrantes disponibles con los filtros'); return; }

      // 3) Draw the final route Start -> bestHydrant -> End
      if (routingControl) { map.removeControl(routingControl); routingControl = null; }
      routingControl = L.Routing.control({
        waypoints: [ L.latLng(start.lat, start.lng), L.latLng(best.lat, best.lng), L.latLng(end.lat, end.lng) ],
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        show: false, routeWhileDragging: false, addWaypoints: false, collapsible: true,
        lineOptions: { addWaypoints: false }
      }).addTo(map);

      const inter = await obtenerInterseccion(best.lat, best.lng);
      const interText = inter ? (inter.secondary ? `${inter.primary} y ${inter.secondary}` : `${inter.primary}`) : 'Intersección no disponible';
      L.popup({ offset: [0,-8] })
        .setLatLng([best.lat, best.lng])
        .setContent(`<strong>Hidrante elegido:</strong> ${best.id} (${best.estado})<br>Intersección: ${interText}<br><small>Distancia a ruta: ~${Math.round(bestD)} m</small>`)
        .openOn(map);
    }

    function clearAll(){
      if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
      if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
      if (routingControl) { map.removeControl(routingControl); routingControl = null; }
    }

    // Buttons + feedback
    function bounce(el){ el.classList.remove('bounce'); void el.offsetWidth; el.classList.add('bounce'); }
    function bindTap(btn, fn){
      const handler = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); bounce(btn); fn(); };
      btn.addEventListener('click', handler, {passive:false});
      btn.addEventListener('pointerup', handler, {passive:false});
      btn.addEventListener('touchend', handler, {passive:false});
    }

    const setStartHereBtn = document.getElementById('setStartHere');
    const setEndHereBtn = document.getElementById('setEndHere');
    const useMyLocationStartBtn = document.getElementById('useMyLocationStart');
    const useMyLocationEndBtn = document.getElementById('useMyLocationEnd');
    const routeBtn = document.getElementById('routeBtn');
    const clearBtn = document.getElementById('clearBtn');
    bindTap(setStartHereBtn, ()=>setPoint('start'));
    bindTap(setEndHereBtn, ()=>setPoint('end'));
    bindTap(useMyLocationStartBtn, ()=>geo('start'));
    bindTap(useMyLocationEndBtn, ()=>geo('end'));
    bindTap(routeBtn, routeViaNearestToRoute);
    bindTap(clearBtn, clearAll);

    // Toast
    let toastEl = null, toastTimer = null;
    function toast(msg){
      if (!toastEl){ toastEl = document.createElement('div'); toastEl.className='toast'; document.body.appendChild(toastEl); }
      toastEl.textContent = msg; toastEl.style.opacity='1';
      clearTimeout(toastTimer); toastTimer = setTimeout(()=>{ if (toastEl){ toastEl.style.opacity='0'; } }, 2600);
    }

    // PWA
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }

    toast('Mové el mapa: el retículo marca el punto. Excluí estados si querés.');
  </script>
</body>
</html>
